<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>港股多因子回测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .input-focus:focus { ring: 2px; ring-color: #667eea; border-color: #667eea; }
        .factor-tag { transition: all 0.2s ease; }
        .factor-tag:hover { transform: translateY(-1px); }
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-line text-2xl"></i>
                    <h1 class="text-2xl font-bold">港股多因子回测系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-80">参考禄得网设计</span>
                    <button onclick="resetAll()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition text-sm">
                        <i class="fas fa-redo mr-2"></i>重置
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-6">
        <div class="grid grid-cols-12 gap-6">
            <!-- Left Panel: Parameters -->
            <div class="col-span-12 lg:col-span-4 space-y-6">
                
                <!-- 1. 股票池范围 -->
                <div class="bg-white rounded-xl card-shadow p-5">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-layer-group text-blue-600"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-gray-800">1. 股票池范围</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">市场范围</label>
                            <select id="marketScope" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">全部港股</option>
                                <option value="hkmain">港股主板</option>
                                <option value="hkgem">港股创业板</option>
                                <option value="hstech">恒生科技成分股</option>
                                <option value="hscei">国企指数成分股</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="excludeSt" class="mr-2" checked>
                                    <span>排除ST股</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="excludeDelist" class="mr-2" checked>
                                    <span>排除退市风险</span>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">最低价格(HKD)</label>
                                <input type="number" id="minPrice" value="1" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">最高价格(HKD)</label>
                                <input type="number" id="maxPrice" value="1000" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">最小市值(亿)</label>
                                <input type="number" id="minMarketCap" value="10" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">最大市值(亿)</label>
                                <input type="number" id="maxMarketCap" value="" placeholder="不限" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. 排序因子 -->
                <div class="bg-white rounded-xl card-shadow p-5">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-sort-amount-down text-purple-600"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-gray-800">2. 排序因子</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center space-x-2">
                            <select id="sortFactor" class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">-- 选择排序因子 --</option>
                                <optgroup label="估值因子">
                                    <option value="pe_asc">市盈率 PE (低到高)</option>
                                    <option value="pe_desc">市盈率 PE (高到低)</option>
                                    <option value="pb_asc">市净率 PB (低到高)</option>
                                    <option value="pb_desc">市净率 PB (高到低)</option>
                                    <option value="ps_asc">市销率 PS (低到高)</option>
                                </optgroup>
                                <optgroup label="动量因子">
                                    <option value="mom_5d">5日涨幅</option>
                                    <option value="mom_20d">20日涨幅</option>
                                    <option value="mom_60d">60日涨幅</option>
                                    <option value="rsi_14">RSI(14)</option>
                                </optgroup>
                                <optgroup label="质量因子">
                                    <option value="roe_desc">ROE (高到低)</option>
                                    <option value="roa_desc">ROA (高到低)</option>
                                    <option value="profit_growth">利润增长率</option>
                                    <option value="revenue_growth">营收增长率</option>
                                </optgroup>
                                <optgroup label="量价因子">
                                    <option value="turnover_20d">20日平均换手率</option>
                                    <option value="volatility_20d">20日波动率</option>
                                    <option value="volume_ratio">量比</option>
                                </optgroup>
                            </select>
                            <button onclick="addSortFactor()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <div id="sortFactorList" class="space-y-2">
                            <!-- 动态添加的排序因子 -->
                        </div>
                    </div>
                </div>

                <!-- 3. 筛选条件 -->
                <div class="bg-white rounded-xl card-shadow p-5">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-filter text-green-600"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-gray-800">3. 筛选条件</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">添加筛选条件</label>
                            <div class="flex items-center space-x-2">
                                <select id="filterFactor" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">-- 选择因子 --</option>
                                    <optgroup label="估值">
                                        <option value="pe">市盈率 PE</option>
                                        <option value="pb">市净率 PB</option>
                                        <option value="ps">市销率 PS</option>
                                        <option value="dividend_yield">股息率</option>
                                    </optgroup>
                                    <optgroup label="动量">
                                        <option value="change_5d">5日涨跌幅</option>
                                        <option value="change_20d">20日涨跌幅</option>
                                        <option value="change_60d">60日涨跌幅</option>
                                        <option value="change_120d">120日涨跌幅</option>
                                        <option value="rsi">RSI</option>
                                        <option value="macd">MACD</option>
                                    </optgroup>
                                    <optgroup label="财务">
                                        <option value="roe">ROE</option>
                                        <option value="roa">ROA</option>
                                        <option value="gross_margin">毛利率</option>
                                        <option value="net_margin">净利率</option>
                                        <option value="debt_ratio">资产负债率</option>
                                    </optgroup>
                                    <optgroup label="量价">
                                        <option value="turnover">换手率</option>
                                        <option value="amplitude">振幅</option>
                                        <option value="volume">成交量</option>
                                    </optgroup>
                                </select>
                                <select id="filterOp" class="w-24 border border-gray-300 rounded-lg px-2 py-2 text-sm">
                                    <option value=">">大于</option>
                                    <option value="<">小于</option>
                                    <option value="=">等于</option>
                                    <option value=">=">大于等于</option>
                                    <option value="<=">小于等于</option>
                                    <option value="between">区间</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2 mt-2">
                                <input type="number" id="filterValue" placeholder="数值" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <input type="number" id="filterValue2" placeholder="最大值(区间用)" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm hidden">
                                <button onclick="addFilter()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="filterList" class="space-y-2">
                            <!-- 动态添加的筛选条件 -->
                        </div>
                    </div>
                </div>

                <!-- 4. 交易规则 -->
                <div class="bg-white rounded-xl card-shadow p-5">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-exchange-alt text-orange-600"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-gray-800">4. 交易规则</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">调仓周期</label>
                            <select id="rebalancePeriod" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="daily">每日调仓</option>
                                <option value="weekly">每周调仓</option>
                                <option value="biweekly">每两周调仓</option>
                                <option value="monthly" selected>每月调仓</option>
                                <option value="quarterly">每季度调仓</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">持仓数量</label>
                            <div class="flex items-center space-x-3">
                                <input type="range" id="holdCount" min="1" max="50" value="10" class="flex-1" oninput="updateHoldCount(this.value)">
                                <span id="holdCountDisplay" class="text-lg font-semibold text-blue-600 w-12">10</span>
                                <span class="text-sm text-gray-500">只</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">个股最大权重</label>
                                <select id="maxWeight" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="0.1">10%</option>
                                    <option value="0.15">15%</option>
                                    <option value="0.2" selected>20%</option>
                                    <option value="0.25">25%</option>
                                    <option value="0.33">33%</option>
                                    <option value="0.5">50%</option>
                                    <option value="1">不设上限</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">权重方式</label>
                                <select id="weightMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="equal">等权重</option>
                                    <option value="market_cap">市值加权</option>
                                    <option value="score">因子得分加权</option>
                                </select>
                            </div>
                        </div>

                        <div class="border-t pt-3">
                            <label class="block text-sm font-medium text-gray-600 mb-2">止盈止损</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">止盈 (%)</label>
                                    <input type="number" id="takeProfit" value="20" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">止损 (%)</label>
                                    <input type="number" id="stopLoss" value="10" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. 回测设置 -->
                <div class="bg-white rounded-xl card-shadow p-5">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-cog text-red-600"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-gray-800">5. 回测设置</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">回测时间范围</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">开始日期</label>
                                    <input type="date" id="startDate" value="2020-01-01" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">结束日期</label>
                                    <input type="date" id="endDate" value="2024-12-31" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">初始资金 (万 HKD)</label>
                            <input type="number" id="initialCapital" value="100" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">买入费率 (%)</label>
                                <input type="number" id="buyFee" value="0.03" step="0.001" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">卖出费率 (%)</label>
                                <input type="number" id="sellFee" value="0.03" step="0.001" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 mb-1">滑点 (%)</label>
                            <input type="number" id="slippage" value="0.1" step="0.01" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 mb-1">基准对比</label>
                            <select id="benchmark" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="hsi">恒生指数 HSI</option>
                                <option value="hstech">恒生科技指数</option>
                                <option value="hscei">国企指数</option>
                                <option value="none">无</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Run Button -->
                <button onclick="runBacktest()" id="runBtn" class="w-full gradient-bg text-white font-semibold py-4 rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-[1.02] flex items-center justify-center space-x-2">
                    <i class="fas fa-play"></i>
                    <span>开始回测</span>
                </button>
            </div>

            <!-- Right Panel: Results -->
            <div class="col-span-12 lg:col-span-8">
                
                <!-- Loading State -->
                <div id="loadingState" class="hidden bg-white rounded-xl card-shadow p-12 text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">正在回测中，请稍候...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="bg-white rounded-xl card-shadow p-12 text-center">
                    <div class="text-gray-300 text-6xl mb-4">
                        <i class="fas fa-chart-area"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">开始你的回测</h3>
                    <p class="text-gray-500">在左侧设置参数，点击"开始回测"查看结果</p>
                </div>

                <!-- Results Container -->
                <div id="resultsContainer" class="hidden space-y-6">
                    
                    <!-- Key Metrics -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">策略收益率</p>
                            <p id="metricReturn" class="text-2xl font-bold text-green-600">--</p>
                        </div>
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">年化收益率</p>
                            <p id="metricAnnualReturn" class="text-2xl font-bold text-blue-600">--</p>
                        </div>
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">最大回撤</p>
                            <p id="metricMaxDrawdown" class="text-2xl font-bold text-red-600">--</p>
                        </div>
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">夏普比率</p>
                            <p id="metricSharpe" class="text-2xl font-bold text-purple-600">--</p>
                        </div>
                    </div>

                    <!-- Additional Metrics -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">基准收益率</p>
                            <p id="metricBenchmark" class="text-xl font-semibold text-gray-700">--</p>
                        </div>
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">超额收益</p>
                            <p id="metricAlpha" class="text-xl font-semibold text-gray-700">--</p>
                        </div>
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">胜率</p>
                            <p id="metricWinRate" class="text-xl font-semibold text-gray-700">--</p>
                        </div>
                        <div class="bg-white rounded-xl card-shadow p-4 metric-card">
                            <p class="text-sm text-gray-500 mb-1">交易次数</p>
                            <p id="metricTradeCount" class="text-xl font-semibold text-gray-700">--</p>
                        </div>
                    </div>

                    <!-- Equity Curve Chart -->
                    <div class="bg-white rounded-xl card-shadow p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">收益曲线</h3>
                            <div class="flex space-x-2">
                                <button onclick="exportData()" class="text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-download mr-1"></i>导出数据
                                </button>
                            </div>
                        </div>
                        <div class="relative h-80">
                            <canvas id="equityChart"></canvas>
                        </div>
                    </div>

                    <!-- Holdings Table -->
                    <div class="bg-white rounded-xl card-shadow p-5">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">最新持仓</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-gray-600">代码</th>
                                        <th class="px-4 py-3 text-left text-gray-600">名称</th>
                                        <th class="px-4 py-3 text-right text-gray-600">权重</th>
                                        <th class="px-4 py-3 text-right text-gray-600">市值</th>
                                        <th class="px-4 py-3 text-right text-gray-600">PE</th>
                                        <th class="px-4 py-3 text-right text-gray-600">PB</th>
                                    </tr>
                                </thead>
                                <tbody id="holdingsTable" class="divide-y divide-gray-100">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Trade History -->
                    <div class="bg-white rounded-xl card-shadow p-5">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">交易记录</h3>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-gray-600">日期</th>
                                        <th class="px-4 py-3 text-left text-gray-600">代码</th>
                                        <th class="px-4 py-3 text-left text-gray-600">名称</th>
                                        <th class="px-4 py-3 text-left text-gray-600">操作</th>
                                        <th class="px-4 py-3 text-right text-gray-600">价格</th>
                                        <th class="px-4 py-3 text-right text-gray-600">数量</th>
                                        <th class="px-4 py-3 text-right text-gray-600">金额</th>
                                    </tr>
                                </thead>
                                <tbody id="tradeHistoryTable" class="divide-y divide-gray-100">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let sortFactors = [];
        let filters = [];
        let equityChart = null;

        // Factor names mapping
        const factorNames = {
            pe_asc: 'PE(低到高)', pe_desc: 'PE(高到低)',
            pb_asc: 'PB(低到高)', pb_desc: 'PB(高到低)',
            ps_asc: 'PS(低到高)',
            mom_5d: '5日涨幅', mom_20d: '20日涨幅', mom_60d: '60日涨幅',
            rsi_14: 'RSI(14)',
            roe_desc: 'ROE(高到低)', roa_desc: 'ROA(高到低)',
            profit_growth: '利润增长率', revenue_growth: '营收增长率',
            turnover_20d: '20日换手率', volatility_20d: '20日波动率', volume_ratio: '量比',
            pe: '市盈率', pb: '市净率', ps: '市销率', dividend_yield: '股息率',
            change_5d: '5日涨跌幅', change_20d: '20日涨跌幅', change_60d: '60日涨跌幅', change_120d: '120日涨跌幅',
            rsi: 'RSI', macd: 'MACD',
            roe: 'ROE', roa: 'ROA', gross_margin: '毛利率', net_margin: '净利率', debt_ratio: '资产负债率',
            turnover: '换手率', amplitude: '振幅', volume: '成交量'
        };

        // Add sort factor
        function addSortFactor() {
            const factor = document.getElementById('sortFactor').value;
            if (!factor) return;
            
            const name = factorNames[factor] || factor;
            sortFactors.push({ factor, name });
            renderSortFactors();
            document.getElementById('sortFactor').value = '';
        }

        // Remove sort factor
        function removeSortFactor(index) {
            sortFactors.splice(index, 1);
            renderSortFactors();
        }

        // Render sort factors
        function renderSortFactors() {
            const container = document.getElementById('sortFactorList');
            container.innerHTML = sortFactors.map((item, index) => `
                <div class="factor-tag flex items-center justify-between bg-purple-50 border border-purple-200 rounded-lg px-3 py-2">
                    <div class="flex items-center">
                        <span class="text-xs bg-purple-600 text-white rounded-full w-5 h-5 flex items-center justify-center mr-2">${index + 1}</span>
                        <span class="text-sm text-purple-800">${item.name}</span>
                    </div>
                    <button onclick="removeSortFactor(${index})" class="text-purple-400 hover:text-purple-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Add filter
        function addFilter() {
            const factor = document.getElementById('filterFactor').value;
            const op = document.getElementById('filterOp').value;
            const value = document.getElementById('filterValue').value;
            const value2 = document.getElementById('filterValue2').value;
            
            if (!factor || !value) return;
            
            const name = factorNames[factor] || factor;
            let displayValue = value;
            if (op === 'between' && value2) {
                displayValue = `${value} ~ ${value2}`;
            }
            
            filters.push({ factor, name, op, value, value2, displayValue });
            renderFilters();
            
            document.getElementById('filterFactor').value = '';
            document.getElementById('filterValue').value = '';
            document.getElementById('filterValue2').value = '';
        }

        // Remove filter
        function removeFilter(index) {
            filters.splice(index, 1);
            renderFilters();
        }

        // Render filters
        function renderFilters() {
            const container = document.getElementById('filterList');
            container.innerHTML = filters.map((item, index) => `
                <div class="factor-tag flex items-center justify-between bg-green-50 border border-green-200 rounded-lg px-3 py-2">
                    <span class="text-sm text-green-800">${item.name} ${item.op} ${item.displayValue}</span>
                    <button onclick="removeFilter(${index})" class="text-green-400 hover:text-green-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Update hold count display
        function updateHoldCount(value) {
            document.getElementById('holdCountDisplay').textContent = value;
        }

        // Handle filter operator change
        document.getElementById('filterOp')?.addEventListener('change', function() {
            const value2Input = document.getElementById('filterValue2');
            if (this.value === 'between') {
                value2Input.classList.remove('hidden');
            } else {
                value2Input.classList.add('hidden');
            }
        });

        // Run backtest
        function runBacktest() {
            // Show loading
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('runBtn').disabled = true;

            // Simulate backtest delay
            setTimeout(() => {
                const results = generateMockResults();
                displayResults(results);
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('resultsContainer').classList.remove('hidden');
                document.getElementById('runBtn').disabled = false;
            }, 2000);
        }

        // Generate mock results
        function generateMockResults() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const days = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            // Generate equity curve data
            const dates = [];
            const strategyValues = [];
            const benchmarkValues = [];
            
            let strategyValue = 100;
            let benchmarkValue = 100;
            
            for (let i = 0; i <= days; i += 30) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                dates.push(date.toISOString().split('T')[0]);
                
                // Random walk with upward bias
                strategyValue *= (1 + (Math.random() - 0.45) * 0.05);
                benchmarkValue *= (1 + (Math.random() - 0.48) * 0.04);
                
                strategyValues.push(strategyValue.toFixed(2));
                benchmarkValues.push(benchmarkValue.toFixed(2));
            }
            
            const totalReturn = ((strategyValue - 100) / 100 * 100).toFixed(2);
            const years = days / 365;
            const annualReturn = (Math.pow(strategyValue / 100, 1 / years) - 1) * 100;
            const benchmarkReturn = ((benchmarkValue - 100) / 100 * 100).toFixed(2);
            
            return {
                totalReturn: totalReturn + '%',
                annualReturn: annualReturn.toFixed(2) + '%',
                maxDrawdown: (Math.random() * 20 + 5).toFixed(2) + '%',
                sharpe: (Math.random() * 1.5 + 0.5).toFixed(2),
                benchmarkReturn: benchmarkReturn + '%',
                alpha: (totalReturn - benchmarkReturn).toFixed(2) + '%',
                winRate: (Math.random() * 20 + 50).toFixed(1) + '%',
                tradeCount: Math.floor(Math.random() * 200 + 50),
                dates,
                strategyValues,
                benchmarkValues,
                holdings: generateMockHoldings(),
                trades: generateMockTrades()
            };
        }

        // Generate mock holdings
        function generateMockHoldings() {
            const stocks = [
                { code: '00700.HK', name: '腾讯控股', pe: 18.5, pb: 3.2 },
                { code: '09988.HK', name: '阿里巴巴', pe: 12.3, pb: 1.5 },
                { code: '03690.HK', name: '美团', pe: 25.6, pb: 4.8 },
                { code: '01211.HK', name: '比亚迪', pe: 22.1, pb: 3.9 },
                { code: '01810.HK', name: '小米集团', pe: 28.3, pb: 2.1 },
                { code: '02318.HK', name: '中国平安', pe: 8.5, pb: 0.9 },
                { code: '00939.HK', name: '建设银行', pe: 4.2, pb: 0.5 },
                { code: '01398.HK', name: '工商银行', pe: 4.5, pb: 0.5 },
                { code: '02331.HK', name: '李宁', pe: 15.8, pb: 2.3 },
                { code: '02015.HK', name: '理想汽车', pe: 35.2, pb: 3.1 }
            ];
            
            const count = parseInt(document.getElementById('holdCount').value);
            const selected = stocks.slice(0, count);
            const totalValue = 1000000; // 100万
            
            return selected.map(stock => ({
                ...stock,
                weight: (100 / count).toFixed(1) + '%',
                value: (totalValue / count / 10000).toFixed(1) + '万'
            }));
        }

        // Generate mock trades
        function generateMockTrades() {
            const trades = [];
            const actions = ['买入', '卖出'];
            const stocks = [
                { code: '00700.HK', name: '腾讯控股' },
                { code: '09988.HK', name: '阿里巴巴' },
                { code: '03690.HK', name: '美团' },
                { code: '01211.HK', name: '比亚迪' }
            ];
            
            for (let i = 0; i < 20; i++) {
                const stock = stocks[Math.floor(Math.random() * stocks.length)];
                const action = actions[Math.floor(Math.random() * actions.length)];
                const price = (Math.random() * 200 + 50).toFixed(2);
                const quantity = Math.floor(Math.random() * 100 + 10) * 100;
                
                trades.push({
                    date: dayjs().subtract(Math.floor(Math.random() * 365), 'day').format('YYYY-MM-DD'),
                    code: stock.code,
                    name: stock.name,
                    action: action,
                    price: price,
                    quantity: quantity,
                    amount: (price * quantity / 10000).toFixed(2) + '万'
                });
            }
            
            return trades.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Display results
        function displayResults(results) {
            // Update metrics
            document.getElementById('metricReturn').textContent = results.totalReturn;
            document.getElementById('metricAnnualReturn').textContent = results.annualReturn;
            document.getElementById('metricMaxDrawdown').textContent = results.maxDrawdown;
            document.getElementById('metricSharpe').textContent = results.sharpe;
            document.getElementById('metricBenchmark').textContent = results.benchmarkReturn;
            document.getElementById('metricAlpha').textContent = results.alpha;
            document.getElementById('metricWinRate').textContent = results.winRate;
            document.getElementById('metricTradeCount').textContent = results.tradeCount;

            // Render chart
            renderChart(results);

            // Render holdings
            document.getElementById('holdingsTable').innerHTML = results.holdings.map(h => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-mono">${h.code}</td>
                    <td class="px-4 py-3">${h.name}</td>
                    <td class="px-4 py-3 text-right">${h.weight}</td>
                    <td class="px-4 py-3 text-right">${h.value}</td>
                    <td class="px-4 py-3 text-right">${h.pe}</td>
                    <td class="px-4 py-3 text-right">${h.pb}</td>
                </tr>
            `).join('');

            // Render trades
            document.getElementById('tradeHistoryTable').innerHTML = results.trades.map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">${t.date}</td>
                    <td class="px-4 py-2 font-mono">${t.code}</td>
                    <td class="px-4 py-2">${t.name}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 rounded text-xs ${t.action === '买入' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                            ${t.action}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-right">${t.price}</td>
                    <td class="px-4 py-2 text-right">${t.quantity}</td>
                    <td class="px-4 py-2 text-right">${t.amount}</td>
                </tr>
            `).join('');
        }

        // Render chart
        function renderChart(results) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            if (equityChart) {
                equityChart.destroy();
            }
            
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: results.dates,
                    datasets: [
                        {
                            label: '策略收益',
                            data: results.strategyValues,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '基准收益',
                            data: results.benchmarkValues,
                            borderColor: '#9ca3af',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Export data
        function exportData() {
            alert('导出功能开发中...');
        }

        // Reset all
        function resetAll() {
            sortFactors = [];
            filters = [];
            renderSortFactors();
            renderFilters();
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default end date to today
            document.getElementById('endDate').value = dayjs().format('YYYY-MM-DD');
        });
    </script>
</body>
</html>
